name: Publish Package

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      triggered-by:
        description: "What triggered this workflow"
        required: false
        type: string
        default: "manual"
      dep-map:
        description: "JSON map of dependencies to update"
        required: false
        type: string
        default: "{}"
      pre-build-script:
        description: "Custom script to run before build"
        required: false
        default: ""
        type: string
      additional-deps:
        description: "Additional build dependencies to install"
        required: false
        default: ""
        type: string
      version-increment:
        description: "Version increment type (patch, minor, major, prerelease)"
        required: false
        default: "patch"
        type: string
      node-version:
        description: "Node.js version to use"
        required: false
        default: "24"
        type: string
      access:
        description: "Package access level (public, restricted)"
        required: false
        default: "public"
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          registry-url: https://registry.npmjs.org/

      - name: Update dependencies
        if: ${{ inputs.dep-map != '{}' }}
        uses: arcmantle/github-actions/replace-deps@main
        with:
          dep-map: ${{ inputs.dep-map }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18

      - name: Run pre-build script
        if: ${{ inputs.pre-build-script != '' }}
        run: ${{ inputs.pre-build-script }}

      - name: Install common build dependencies.
        run: pnpm add -D rimraf typescript @arcmantle/tsconfig @types/node ${{ inputs.additional-deps }}

      - name: Install dependencies.
        run: pnpm install

      - name: Build project.
        run: pnpm build

      - name: Calculate version with Prospector
        id: version
        run: |
          echo "ðŸ” Using Prospector to calculate version..."
          VERSION=$(node bin/bin.js)
          echo "ðŸ“¦ Calculated version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          PACKAGE_NAME=$(node -p "require('./package.json').name")
          echo "package=$PACKAGE_NAME" >> $GITHUB_OUTPUT

      - name: Set package version
        run: |
          echo "âœ… Setting package version to ${{ steps.version.outputs.version }}"
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version
          echo "ðŸ“¦ Package ${{ steps.version.outputs.package }} ready to publish"

      #- name: Publish to NPM
      #  run: pnpm publish --access ${{ inputs.access }} --no-git-checks
      #  env:
      #    NODE_AUTH_TOKEN: ${{ secrets.NPM_PUBLISH }}
      #    NPM_TOKEN: ${{ secrets.NPM_PUBLISH }}

    #uses: arcmantle/github-workflows/.github/workflows/pnpm-publish.yml@main
    #with:
    #  triggered-by:  ${{ inputs.triggered-by }}
    #  dep-map: ${{ inputs.dep-map }}
    #  pre-build-script: ${{ inputs.pre-build-script }}
    #  additional-deps: ${{ inputs.additional-deps }}
    #  version-increment: ${{ inputs.version-increment }}
    #  node-version: ${{ inputs.node-version }}
    #  access: ${{ inputs.access }}
    #secrets:
    #  NPM_PUBLISH: ${{ secrets.NPM_PUBLISH }}
